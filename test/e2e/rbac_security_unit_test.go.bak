//go:build e2e
// +build e2e

/*
Copyright 2025.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/

package e2e

import (
	"context"
	"fmt"

	. "github.com/onsi/ginkgo/v2"
	. "github.com/onsi/gomega"

	"github.com/optipod/optipod/api/v1alpha1"
	"github.com/optipod/optipod/test/e2e/helpers"

	corev1 "k8s.io/api/core/v1"
	rbacv1 "k8s.io/api/rbac/v1"
	"k8s.io/apimachinery/pkg/api/errors"
	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
	"k8s.io/apimachinery/pkg/runtime"
	"k8s.io/apimachinery/pkg/types"
	"k8s.io/client-go/kubernetes/scheme"
	"sigs.k8s.io/controller-runtime/pkg/client"
	"sigs.k8s.io/controller-runtime/pkg/client/config"
)

var _ = Describe("RBAC Unit Tests", Ordered, func() {
	var (
		k8sClient     client.Client
		testNamespace string
		cleanupHelper *helpers.CleanupHelper
		rbacHelper    *RBACHelper
	)

	BeforeAll(func() {
		By("setting up test environment")

		// Initialize Kubernetes client
		cfg, err := config.GetConfig()
		Expect(err).NotTo(HaveOccurred())

		// Add OptipPod scheme
		s := runtime.NewScheme()
		Expect(scheme.AddToScheme(s)).To(Succeed())
		Expect(v1alpha1.AddToScheme(s)).To(Succeed())

		k8sClient, err = client.New(cfg, client.Options{Scheme: s})
		Expect(err).NotTo(HaveOccurred())

		// Set up namespace
		testNamespace = "rbac-unit-test"

		// Initialize helpers
		cleanupHelper = helpers.NewCleanupHelper(k8sClient)
		rbacHelper = NewRBACHelper(k8sClient, cleanupHelper)

		// Create test namespace
		testNs := &corev1.Namespace{
			ObjectMeta: metav1.ObjectMeta{
				Name: testNamespace,
				Labels: map[string]string{
					"rbac-unit-test": "true",
				},
			},
		}
		err = k8sClient.Create(context.TODO(), testNs)
		if err != nil && !errors.IsAlreadyExists(err) {
			Expect(err).NotTo(HaveOccurred(), "Failed to create test namespace")
		}
		cleanupHelper.TrackNamespace(testNamespace)
	})

	AfterAll(func() {
		By("cleaning up test resources")
		err := cleanupHelper.CleanupAll()
		Expect(err).NotTo(HaveOccurred(), "Failed to cleanup test resources")
	})

	Context("Service Account Creation Unit Tests", func() {
		It("should create service account with correct metadata", func() {
			saName := "test-service-account"

			sa, err := rbacHelper.CreateRestrictedServiceAccount(saName, testNamespace, []string{"get", "list"})
			Expect(err).NotTo(HaveOccurred())
			Expect(sa).NotTo(BeNil())
			Expect(sa.Name).To(Equal(saName))
			Expect(sa.Namespace).To(Equal(testNamespace))
		})

		It("should create service account with associated role", func() {
			saName := "test-sa-with-role"
			verbs := []string{"get", "list", "watch"}

			sa, err := rbacHelper.CreateRestrictedServiceAccount(saName, testNamespace, verbs)
			Expect(err).NotTo(HaveOccurred())
			Expect(sa).NotTo(BeNil())

			// Verify role was created
			roleName := fmt.Sprintf("%s-role", saName)
			role := &rbacv1.Role{}
			err = k8sClient.Get(context.TODO(), types.NamespacedName{
				Name:      roleName,
				Namespace: testNamespace,
			}, role)
			Expect(err).NotTo(HaveOccurred())
			Expect(role.Name).To(Equal(roleName))
		})

		It("should create service account with associated role binding", func() {
			saName := "test-sa-with-binding"
			verbs := []string{"get", "list"}

			sa, err := rbacHelper.CreateRestrictedServiceAccount(saName, testNamespace, verbs)
			Expect(err).NotTo(HaveOccurred())
			Expect(sa).NotTo(BeNil())

			// Verify role binding was created
			roleBindingName := fmt.Sprintf("%s-binding", saName)
			roleBinding := &rbacv1.RoleBinding{}
			err = k8sClient.Get(context.TODO(), types.NamespacedName{
				Name:      roleBindingName,
				Namespace: testNamespace,
			}, roleBinding)
			Expect(err).NotTo(HaveOccurred())
			Expect(roleBinding.Name).To(Equal(roleBindingName))

			// Verify role binding references correct service account
			found := false
			for _, subject := range roleBinding.Subjects {
				if subject.Kind == "ServiceAccount" && subject.Name == saName && subject.Namespace == testNamespace {
					found = true
					break
				}
			}
			Expect(found).To(BeTrue())
		})

		It("should create read-only service account correctly", func() {
			saName := "readonly-test-sa"

			sa, err := rbacHelper.CreateReadOnlyServiceAccount(saName, testNamespace)
			Expect(err).NotTo(HaveOccurred())
			Expect(sa).NotTo(BeNil())

			// Verify permissions are read-only
			err = rbacHelper.ValidateReadOnlyPermissions(saName, testNamespace)
			Expect(err).NotTo(HaveOccurred())

			err = rbacHelper.ValidateWriteOperationsBlocked(saName, testNamespace)
			Expect(err).NotTo(HaveOccurred())
		})
	})

	Context("Permission Validation Unit Tests", func() {
		It("should validate service account permissions correctly", func() {
			saName := "permission-test-sa"
			expectedVerbs := []string{"get", "list", "watch"}

			sa, err := rbacHelper.CreateRestrictedServiceAccount(saName, testNamespace, expectedVerbs)
			Expect(err).NotTo(HaveOccurred())
			Expect(sa).NotTo(BeNil())

			err = rbacHelper.ValidateServiceAccountPermissions(saName, testNamespace, expectedVerbs)
			Expect(err).NotTo(HaveOccurred())
		})

		It("should detect missing permissions", func() {
			saName := "missing-perms-sa"
			actualVerbs := []string{"get", "list"}
			expectedVerbs := []string{"get", "list", "watch", "create"}

			sa, err := rbacHelper.CreateRestrictedServiceAccount(saName, testNamespace, actualVerbs)
			Expect(err).NotTo(HaveOccurred())
			Expect(sa).NotTo(BeNil())

			err = rbacHelper.ValidateServiceAccountPermissions(saName, testNamespace, expectedVerbs)
			Expect(err).To(HaveOccurred())
			Expect(err.Error()).To(ContainSubstring("expected verb"))
		})

		It("should validate no permission escalation", func() {
			saName := "no-escalation-sa"
			verbs := []string{"get", "list"}

			sa, err := rbacHelper.CreateRestrictedServiceAccount(saName, testNamespace, verbs)
			Expect(err).NotTo(HaveOccurred())
			Expect(sa).NotTo(BeNil())

			err = rbacHelper.ValidateNoPermissionEscalation(saName, testNamespace)
			Expect(err).NotTo(HaveOccurred())
		})

		It("should validate unauthorized operations are blocked", func() {
			saName := "unauthorized-test-sa"
			verbs := []string{"get"}

			sa, err := rbacHelper.CreateRestrictedServiceAccount(saName, testNamespace, verbs)
			Expect(err).NotTo(HaveOccurred())
			Expect(sa).NotTo(BeNil())

			err = rbacHelper.ValidateUnauthorizedOperationsBlocked(saName, testNamespace)
			Expect(err).NotTo(HaveOccurred())
		})

		It("should validate write operations are blocked for read-only accounts", func() {
			saName := "write-blocked-sa"

			sa, err := rbacHelper.CreateReadOnlyServiceAccount(saName, testNamespace)
			Expect(err).NotTo(HaveOccurred())
			Expect(sa).NotTo(BeNil())

			err = rbacHelper.ValidateWriteOperationsBlocked(saName, testNamespace)
			Expect(err).NotTo(HaveOccurred())
		})
	})

	Context("RBAC Helper Edge Cases", func() {
		It("should handle non-existent service account gracefully", func() {
			saName := "non-existent-sa"

			err := rbacHelper.ValidateServiceAccountPermissions(saName, testNamespace, []string{"get"})
			Expect(err).To(HaveOccurred())
			Expect(err.Error()).To(ContainSubstring("failed to get role"))
		})

		It("should handle empty permissions list", func() {
			saName := "empty-perms-sa"

			sa, err := rbacHelper.CreateRestrictedServiceAccount(saName, testNamespace, []string{})
			Expect(err).NotTo(HaveOccurred())
			Expect(sa).NotTo(BeNil())

			err = rbacHelper.ValidateServiceAccountPermissions(saName, testNamespace, []string{})
			Expect(err).NotTo(HaveOccurred())
		})

		It("should handle orphaned service account", func() {
			// Create service account but not the role
			sa := &corev1.ServiceAccount{
				ObjectMeta: metav1.ObjectMeta{
					Name:      "orphaned-sa",
					Namespace: testNamespace,
				},
			}
			err := k8sClient.Create(context.TODO(), sa)
			Expect(err).NotTo(HaveOccurred())
			cleanupHelper.TrackServiceAccount(sa.Name, sa.Namespace)

			err = rbacHelper.ValidateServiceAccountPermissions(sa.Name, testNamespace, []string{"get"})
			Expect(err).To(HaveOccurred())
			Expect(err.Error()).To(ContainSubstring("failed to get role"))
		})
	})
})
