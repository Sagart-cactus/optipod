name: E2E Tests

on:
  push:
  pull_request:

env:
  # Test configuration
  E2E_TEST_TIMEOUT: "30m"
  E2E_PARALLEL_NODES: "4"
  GINKGO_JUNIT_REPORT: "true"
  
jobs:
  test-e2e:
    name: Run E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      contents: read
      actions: read
      checks: write
      pull-requests: write
    steps:
      - name: Clone the code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Install the latest version of kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/latest/kind-linux-$(go env GOARCH)
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

      - name: Verify kind installation
        run: kind version

      - name: Create test artifacts directory
        run: |
          mkdir -p test-artifacts/logs
          mkdir -p test-artifacts/reports
          mkdir -p test-artifacts/coverage

      - name: Setup test environment
        run: |
          go mod tidy
          make setup-test-e2e

      - name: Run E2E tests with reporting
        id: e2e-tests
        run: |
          export GINKGO_JUNIT_REPORT_FILE="test-artifacts/reports/junit-e2e-tests.xml"
          export GINKGO_JSON_REPORT_FILE="test-artifacts/reports/report-e2e-tests.json"
          export E2E_TEST_FOCUS="Unit Tests"
          make test-e2e-enhanced || echo "Tests completed with status $?"
        continue-on-error: true

      - name: Collect test artifacts on failure
        if: failure() || steps.e2e-tests.outcome == 'failure'
        run: |
          # Collect Kind cluster logs
          kind export logs test-artifacts/logs/kind-logs --name optipod-test-e2e || true
          
          # Collect controller logs
          kubectl logs -n optipod-system deployment/optipod-controller-manager > test-artifacts/logs/controller.log || true
          
          # Collect cluster state
          kubectl get all -A > test-artifacts/logs/cluster-state.yaml || true
          kubectl describe nodes > test-artifacts/logs/nodes.yaml || true
          
          # Collect events
          kubectl get events -A --sort-by='.lastTimestamp' > test-artifacts/logs/events.yaml || true

      - name: Generate test summary
        if: always()
        run: |
          echo "## E2E Test Results" > test-artifacts/summary.md
          echo "- **Test Suite**: Unit Tests" >> test-artifacts/summary.md
          echo "- **Status**: ${{ steps.e2e-tests.outcome }}" >> test-artifacts/summary.md
          echo "- **Timestamp**: $(date -u)" >> test-artifacts/summary.md
          
          if [ -f "test-artifacts/reports/junit-e2e-tests.xml" ]; then
            echo "- **JUnit Report**: Available" >> test-artifacts/summary.md
          fi

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-artifacts
          path: test-artifacts/
          retention-days: 30

      - name: Upload test results (PR only)
        if: always() && github.event_name == 'pull_request'
        uses: dorny/test-reporter@v1
        with:
          name: E2E Tests
          path: test-artifacts/reports/junit-e2e-tests.xml
          reporter: java-junit
          fail-on-error: false

      - name: Display test results summary (Push to main)
        if: always() && github.event_name == 'push'
        run: |
          echo "## E2E Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "test-artifacts/reports/junit-e2e-tests.xml" ]; then
            # Extract test counts from JUnit XML
            TOTAL_TESTS=$(grep -o 'tests="[0-9]*"' test-artifacts/reports/junit-e2e-tests.xml | head -1 | grep -o '[0-9]*')
            FAILURES=$(grep -o 'failures="[0-9]*"' test-artifacts/reports/junit-e2e-tests.xml | head -1 | grep -o '[0-9]*')
            ERRORS=$(grep -o 'errors="[0-9]*"' test-artifacts/reports/junit-e2e-tests.xml | head -1 | grep -o '[0-9]*')
            SKIPPED=$(grep -o 'skipped="[0-9]*"' test-artifacts/reports/junit-e2e-tests.xml | head -1 | grep -o '[0-9]*')
            
            PASSED=$((TOTAL_TESTS - FAILURES - ERRORS - SKIPPED))
            
            echo "- **Total Tests**: $TOTAL_TESTS" >> $GITHUB_STEP_SUMMARY
            echo "- **Passed**: $PASSED ✅" >> $GITHUB_STEP_SUMMARY
            echo "- **Failed**: $FAILURES ❌" >> $GITHUB_STEP_SUMMARY
            echo "- **Errors**: $ERRORS ⚠️" >> $GITHUB_STEP_SUMMARY
            echo "- **Skipped**: $SKIPPED ⏭️" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "$FAILURES" -gt 0 ] || [ "$ERRORS" -gt 0 ]; then
              echo "❌ **Test Status**: FAILED" >> $GITHUB_STEP_SUMMARY
            else
              echo "✅ **Test Status**: PASSED" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "⚠️ No test results found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Cleanup test environment
        if: always()
        run: |
          make cleanup-test-e2e || true

  test-e2e-summary:
    name: E2E Test Summary
    runs-on: ubuntu-latest
    needs: test-e2e
    if: always() && github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: all-artifacts

      - name: Generate combined summary
        run: |
          echo "# E2E Test Suite Summary" > combined-summary.md
          echo "" >> combined-summary.md
          
          if [ -f "all-artifacts/e2e-test-artifacts/summary.md" ]; then
            cat "all-artifacts/e2e-test-artifacts/summary.md" >> combined-summary.md
            echo "" >> combined-summary.md
          fi

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('combined-summary.md')) {
              const summary = fs.readFileSync('combined-summary.md', 'utf8');
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: summary
              });
            }
