name: E2E Tests

on:
  push:
  pull_request:

env:
  # Test configuration
  E2E_TEST_TIMEOUT: "30m"
  E2E_PARALLEL_NODES: "4"
  GINKGO_JUNIT_REPORT: "true"
  
jobs:
  test-e2e:
    name: Run E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        test-suite: [policy-modes, resource-bounds, rbac-security, error-handling]
    steps:
      - name: Clone the code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Install the latest version of kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/latest/kind-linux-$(go env GOARCH)
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

      - name: Verify kind installation
        run: kind version

      - name: Create test artifacts directory
        run: |
          mkdir -p test-artifacts/logs
          mkdir -p test-artifacts/reports
          mkdir -p test-artifacts/coverage

      - name: Setup test environment
        run: |
          go mod tidy
          make setup-test-e2e

      - name: Run E2E tests with reporting
        id: e2e-tests
        run: |
          export GINKGO_JUNIT_REPORT_FILE="test-artifacts/reports/junit-${{ matrix.test-suite }}.xml"
          export GINKGO_JSON_REPORT_FILE="test-artifacts/reports/report-${{ matrix.test-suite }}.json"
          export E2E_TEST_FOCUS="${{ matrix.test-suite }}"
          make test-e2e-enhanced || echo "Tests completed with status $?"
        continue-on-error: true

      - name: Collect test artifacts on failure
        if: failure() || steps.e2e-tests.outcome == 'failure'
        run: |
          # Collect Kind cluster logs
          kind export logs test-artifacts/logs/kind-logs --name optipod-test-e2e || true
          
          # Collect controller logs
          kubectl logs -n optipod-system deployment/optipod-controller-manager > test-artifacts/logs/controller.log || true
          
          # Collect cluster state
          kubectl get all -A > test-artifacts/logs/cluster-state.yaml || true
          kubectl describe nodes > test-artifacts/logs/nodes.yaml || true
          
          # Collect events
          kubectl get events -A --sort-by='.lastTimestamp' > test-artifacts/logs/events.yaml || true

      - name: Generate test summary
        if: always()
        run: |
          echo "## E2E Test Results - ${{ matrix.test-suite }}" > test-artifacts/summary.md
          echo "- **Test Suite**: ${{ matrix.test-suite }}" >> test-artifacts/summary.md
          echo "- **Status**: ${{ steps.e2e-tests.outcome }}" >> test-artifacts/summary.md
          echo "- **Timestamp**: $(date -u)" >> test-artifacts/summary.md
          
          if [ -f "test-artifacts/reports/junit-${{ matrix.test-suite }}.xml" ]; then
            echo "- **JUnit Report**: Available" >> test-artifacts/summary.md
          fi

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-artifacts-${{ matrix.test-suite }}
          path: test-artifacts/
          retention-days: 30

      - name: Upload test results
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: E2E Tests - ${{ matrix.test-suite }}
          path: test-artifacts/reports/junit-${{ matrix.test-suite }}.xml
          reporter: java-junit
          fail-on-error: false

      - name: Cleanup test environment
        if: always()
        run: |
          make cleanup-test-e2e || true

  test-e2e-summary:
    name: E2E Test Summary
    runs-on: ubuntu-latest
    needs: test-e2e
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Generate combined summary
        run: |
          echo "# E2E Test Suite Summary" > combined-summary.md
          echo "" >> combined-summary.md
          
          for suite in policy-modes resource-bounds rbac-security error-handling; do
            if [ -f "all-artifacts/e2e-test-artifacts-$suite/summary.md" ]; then
              cat "all-artifacts/e2e-test-artifacts-$suite/summary.md" >> combined-summary.md
              echo "" >> combined-summary.md
            fi
          done

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('combined-summary.md')) {
              const summary = fs.readFileSync('combined-summary.md', 'utf8');
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: summary
              });
            }
